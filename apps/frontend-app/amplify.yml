version: 1
applications:
  - appRoot: apps/frontend-app
    backend:
      phases:
        preBuild:
          commands:
            - nvm use 22
            - corepack enable
            - corepack prepare pnpm@10.12.1 --activate
            - echo "Installing workspace dependencies from root"
            - cd ../.. && pnpm install --frozen-lockfile --prefer-offline
        build:
          commands:
            - cd apps/frontend-app
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
    frontend:
      phases:
        preBuild:
          commands:
            - nvm use 22
            - corepack enable
            - corepack prepare pnpm@10.12.1 --activate
            - echo "Installing workspace dependencies from root"
            - cd ../.. && pnpm install --frozen-lockfile --prefer-offline
        build:
          commands:
            - cd apps/frontend-app
            - pnpm run build
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'Strict-Transport-Security'
              value: 'max-age=31536000; includeSubDomains'
            - key: 'X-Frame-Options'
              value: 'SAMEORIGIN'
            - key: 'X-Content-Type-Options'
              value: 'nosniff'
        - pattern: '**/*.js'
          headers:
            - key: 'Cache-Control'
              value: 'public, max-age=31536000, immutable'
        - pattern: '**/*.css'
          headers:
            - key: 'Cache-Control'
              value: 'public, max-age=31536000, immutable'
        - pattern: '/static/**/*'
          headers:
            - key: 'Cache-Control'
              value: 'public, max-age=31536000, immutable'
      redirects:
        - source: '/<*>'
          target: '/index.html'
          status: '200'
